<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguridad Privada Chile</title>
    <!-- Favicon de ejemplo para evitar errores 404 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E%F0%9F%9B%A1%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS (for lupa, person, document, terminal, keyboard, variable, unit icons) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Estilos Base */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f8f8; /* Blanco muy claro para el fondo */
            color: #333; /* Texto oscuro */
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Evitar scroll horizontal */
            display: flex; /* Usar flexbox para el layout principal */
            flex-direction: column; /* Columna por defecto */
            min-height: 100vh; /* Asegura que el cuerpo ocupe al menos toda la altura de la ventana */
        }

        /* Capa superpuesta para efecto de desenfoque */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* Blanco semi-transparente */
            backdrop-filter: blur(3px); /* Ligeramente suave */
            -webkit-backdrop-filter: blur(3px);
            z-index: -1;
        }

        /* Personalización de la barra de navegación */
        .navbar-custom {
            background-color: rgba(23, 27, 74, 0.9); /* Azul oscuro (#171b4a) menos transparente */
            backdrop-filter: blur(5px); /* Desenfoque para el banner */
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease-in-out;
            padding: 1rem 3%;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Sombra sutil */
        }

        .navbar-custom .navbar-brand {
            font-weight: 700;
            color: #ffffff; /* Blanco para el logo */
            transition: font-size 0.3s ease-in-out;
            margin-right: 0;
            display: flex;
            align-items: center;
        }

        /* Estilos para el logo dentro de la marca de la barra de navegación */
        .navbar-brand .brand-text {
            /* No styles needed here as img is positioned after text */
        }

        .navbar-brand img {
            height: 40px; /* Tamaño del logo más grande en PC */
            margin-left: 10px; /* Espacio a la izquierda del logo (para que esté a la derecha del texto) */
        }

        .navbar-custom .nav-link {
            color: #ffffff !important; /* Texto de los enlaces blanco */
            font-weight: 600;
            position: relative;
            text-decoration: none;
            transition: color 0.3s ease-in-out, text-decoration 0.3s ease-in-out;
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border-radius: 5px;
        }

        .navbar-custom .nav-link:hover {
            color: #b2b6dc !important; /* Tono más claro del azul oscuro al pasar el cursor */
        }

        .navbar-custom .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #b2b6dc; /* Tono más claro para el subrayado */
            transition: width 0.3s ease-in-out;
        }

        .navbar-custom .nav-link:hover::after {
            width: 80%;
        }

        /* Reducción de la barra de navegación al hacer scroll */
        .navbar-shrink {
            padding: 0.5rem 3%;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            background-color: rgba(23, 27, 74, 0.95); /* Azul oscuro aún más opaco al encogerse */
            backdrop-filter: blur(8px); /* Más desenfoque al encogerse */
            -webkit-backdrop-filter: blur(8px);
        }

        .navbar-shrink .navbar-brand {
            font-size: 1.2rem;
        }

        /* Botón de búsqueda (lupa) */
        .search-toggler {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out;
            margin-left: 10px;
            display: flex; /* Asegura que la lupa sea visible */
            align-items: center;
            justify-content: center;
        }

        .search-toggler:hover {
            transform: scale(1.08);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .search-toggler i {
            color: #ffffff; /* Blanco para la lupa */
            font-size: 1.2rem;
        }

        /* Contenedor de la barra de búsqueda (el input) */
        .search-bar-container {
            position: absolute;
            top: 100%; /* Justo debajo de la navbar */
            left: 0;
            width: 100%;
            background-color: #171b4a; /* Azul oscuro (#171b4a) */
            padding: 10px 3%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: none; /* Oculto por defecto */
            z-index: 1000;
        }

        .search-bar-container.show {
            display: block; /* Muestra el input cuando se añade la clase .show */
        }

        .search-bar-container input {
            width: 100%;
            border-radius: 20px; /* Puntas más redondeadas */
            border: 1px solid #333;
            padding: 8px;
            font-family: 'Poppins', sans-serif;
            background-color: #f0f0f0; /* Gris claro */
            color: #333;
        }

        .search-bar-container input::placeholder {
            color: #666;
        }

        /* Botón de Contacto */
        .contact-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out;
            margin-left: 10px;
        }

        .contact-btn:hover {
            transform: scale(1.08);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .contact-btn i {
            color: #ffffff;
            font-size: 1.2rem;
        }

        /* Botón de menú móvil (Hamburguesa) */
        .navbar-toggler {
            border: 1px solid #ffffff; /* Círculo blanco */
            border-radius: 50%; /* Hacerlo circular */
            padding: 5px; /* Espacio alrededor del icono */
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255,255,255,1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
            width: 1.2em; /* Tamaño del icono */
            height: 1.2em;
        }

        /* Área de Contenido Principal */
        .main-content {
            flex-grow: 1; /* Ocupa el espacio restante */
            padding: 20px 8%;
            text-align: justify;
            line-height: 1.6;
            color: #333;
            min-width: 0; /* Permite que se encoja */
            padding-top: 100px; /* Ajuste para el banner fijo */
        }

        /* Estilo de sección de información (ventanas transparentes) */
        .info-section {
            background-color: rgba(255, 255, 255, 0.7); /* Blanco semi-transparente como ventanas */
            padding: 30px;
            border-radius: 15px;
            border: 2px solid transparent; /* Borde inicial transparente */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            text-align: center;
            position: relative; /* Para la ventana flotante roja */
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Transición para el hover */
        }
        /* Borde e iluminación para todas las secciones de información al hacer hover */
        .info-section:hover {
            border-color: #dc3545; /* Color del borde al hacer hover (rojo) */
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4), 0 0 15px rgba(220, 53, 69, 0.6); /* Sombra que simula el resplandor */
        }
        /* Estilo específico para la sección de examen al hacer hover */
        #exam-section:hover {
            border-color: #dc3545; /* Rojo también para el hover del examen */
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4), 0 0 15px rgba(220, 53, 69, 0.6); /* Sombra que simula el resplandor */
        }
        /* Estilo para la sección de examen cuando está activa */
        #exam-section.active-red-border {
            border-color: #dc3545; /* Rojo permanente */
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.6), 0 0 20px rgba(220, 53, 69, 0.8); /* Resplandor más fuerte */
        }


        .main-content h1, .main-content h2, .main-content h3,
        .main-content h4, .main-content h5, .main-content h6 {
            font-weight: 700;
            font-size: 1.8rem;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            text-align: center;
            color: #283593; /* Azul oscuro (#283593) para los encabezados de sección */
        }

        .main-content p {
            margin-bottom: 1.5em;
        }

        .main-content a {
            font-weight: bold;
            color: #283593; /* Azul oscuro (#283593) para los enlaces */
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease-in-out;
        }

        .main-content a:hover {
            color: #515ba6; /* Azul medio al pasar el cursor */
            text-decoration: underline;
        }

        /* Imágenes */
        .main-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .image-caption {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            margin-bottom: 20px;
        }

        /* Listas */
        .main-content ul {
            list-style: none;
            padding-left: 0;
            text-align: left; /* Alineación a la izquierda para las listas */
        }

        .main-content ul li::before {
            content: "\2023";
            font-size: 1em;
            color: #283593; /* Azul oscuro (#283593) para las viñetas */
            position: absolute;
            left: 0;
            top: 0.1em;
        }

        /* Citas en bloque */
        .main-content blockquote {
            background-color: rgba(40, 53, 147, 0.1); /* Azul oscuro semi-transparente */
            border-left: 5px solid #283593; /* Borde azul oscuro */
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 8px;
            font-style: italic;
            color: #515ba6; /* Azul medio para el texto */
        }

        /* Videos */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 100%;
        }

        .video-container iframe,
        .video-container object,
        .video-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        /* Íconos para elementos especiales */
        .icon-small {
            font-size: 0.9em;
            vertical-align: middle;
            margin-right: 5px;
            color: #283593; /* Azul oscuro (#283593) para los íconos pequeños */
        }

        /* Estilo para el banner de instalación de PWA (creado dinámicamente) */
        #dynamic-install-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #283593; /* Azul oscuro para el banner */
            color: white;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #dynamic-install-banner button {
            margin-left: 10px;
            padding: 8px 16px;
            background: #e8eaf6; /* Azul muy claro para el botón */
            color: #283593; /* Texto azul oscuro */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #dynamic-install-banner button:hover {
            background-color: #c5cae9; /* Azul más oscuro al pasar el cursor */
            transform: translateY(-1px);
        }

        /* Pie de página */
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #171b4a; /* Azul oscuro del banner principal */
            color: #f8f8f8;
            font-size: 0.9em;
            margin-top: 50px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
        }

        /* Estilos de la sección de Examen */
        /* Ya definidos arriba para el hover */

        #exam-section {
            background-color: rgba(255, 255, 255, 0.7); /* Ventanas transparentes */
            padding: 30px;
            border-radius: 15px;
            border: 2px solid transparent; /* Borde inicial transparente */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            text-align: center;
            position: relative; /* Para la ventana flotante roja */
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Transición para el hover */
            min-height: 500px; /* Hacer el container del examen más largo verticalmente */
        }

        #start-exam-btn {
            background-color: #dc3545; /* Rojo */
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: 20px;
            display: block; /* Para centrar el botón */
            margin-left: auto; /* Para centrar el botón */
            margin-right: auto; /* Para centrar el botón */
        }

        #start-exam-btn:hover {
            background-color: #c82333; /* Rojo más oscuro para hover */
            transform: translateY(-3px);
        }

        #quiz-container {
            text-align: left;
        }

        .question-card {
            background-color: rgba(255, 255, 255, 0.8); /* Fondo de pregunta ligeramente transparente */
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.05); /* Borde inicial casi transparente */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Transición para el borde azul */
        }

        .question-card h5 {
            color: #333; /* Texto de pregunta oscuro */
            font-weight: 700;
            font-size: 1.1em;
            text-align: justify;
            margin-bottom: 15px;
        }
        
        /* Estilos para las opciones de Verdadero/Falso como botones */
        .option-button {
            display: inline-block; /* Ocupa el espacio de su contenido */
            background-color: #f0f0f0; /* Color de fondo normal del botón */
            color: #333; /* Color de texto normal */
            border: 1px solid #ccc; /* Borde del botón */
            border-radius: 8px; /* Bordes redondeados */
            padding: 10px 20px;
            margin: 5px; /* Espacio entre botones */
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            user-select: none; /* Evita selección de texto */
        }

        .option-button:hover {
            background-color: #e0e0e0; /* Color al pasar el mouse */
            transform: translateY(-2px); /* Pequeño efecto de elevación */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Estilo para botón seleccionado */
        .option-button.selected {
            background-color: #283593; /* Azul oscuro al seleccionar */
            color: white; /* Texto blanco al seleccionar */
            border-color: #283593;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        /* Estilo para el borde del question-card cuando una pregunta ha sido respondida */
        .question-card.answered-blue-border {
            border-color: #2196f3; /* Azul para el borde de la pregunta respondida */
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4); /* Resplandor azul */
        }

        /* Ocultar los radio buttons originales */
        .form-check-input[type="radio"] {
            display: none;
        }

        /* Asegurar que el label ocupe todo el espacio del botón */
        .form-check-label.option-button {
            width: auto; /* Permite que el ancho se ajuste al contenido */
        }

        .exam-controls {
            text-align: center;
            margin-top: 30px;
        }

        .exam-controls button {
            background-color: #283593;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .exam-controls button:hover {
            background-color: #1a237e;
            transform: translateY(-2px);
        }

        #exam-results {
            background-color: rgba(40, 53, 147, 0.3); /* Fondo azul oscuro semi-transparente para resultados */
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
            border: 1px solid rgba(40,53,147,0.5);
            color: #e8eaf6; /* Texto claro */
        }

        #exam-results h3 {
            color: #e8eaf6; /* Azul muy claro */
        }
        /* Estilo para la nota final con animación */
        #exam-results p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a237e; /* Color oscuro para la nota */
            animation: pulse-grade 4s infinite; /* Aplicar animación */
        }

        /* Keyframes para la animación de la nota */
        @keyframes pulse-grade {
            0% { transform: scale(1); opacity: 1; text-shadow: 0 0 0px rgba(255, 255, 255, 0); }
            50% { transform: scale(1.05); opacity: 0.9; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
            100% { transform: scale(1); opacity: 1; text-shadow: 0 0 0px rgba(255, 255, 255, 0); }
        }


        /* Estilo del chat flotante de IA */
        #ai-clarifier-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px; /* Ancho predeterminado para PC */
            height: 450px; /* Alto predeterminado para PC */
            background-color: #b3e5fc; /* Azul claro */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: none; /* Oculto por defecto */
            flex-direction: column;
            justify-content: space-between;
            z-index: 1060; /* Por encima de todo lo demás */
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(0,0,0,0.1);
            color: #333;
        }

        #ai-clarifier-chat.show {
            display: flex;
        }

        #ai-clarifier-chat .chat-header {
            display: flex;
            justify-content: flex-start; /* Alinear al inicio para texto e imagen */
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: relative; /* Para posicionar el botón de cierre */
        }

        #ai-clarifier-chat .chat-header h2 {
            font-size: 1.0rem; /* Tamaño de fuente para PC */
            margin: 0;
            color: #283593; /* Azul oscuro */
            margin-right: 10px; /* Espacio entre título y logo */
        }

        #ai-clarifier-chat .chat-header .close-button {
            position: absolute; /* Posicionamiento absoluto */
            top: -5px; /* Mover ligeramente hacia arriba para que no quede tan pegado */
            right: 0px; /* Mover a la orilla derecha */
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #555;
            cursor: pointer;
            padding: 0; /* Eliminar padding por defecto del botón */
        }

        #ai-clarifier-chat .chat-header .close-button:hover {
            color: #000;
        }

        #ai-clarifier-chat .chat-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px; /* Espacio para scrollbar */
            margin-bottom: 15px;
        }

        #ai-clarifier-chat .chat-content p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        #ai-clarifier-chat textarea {
            width: 100%;
            height: 80px; /* Más pequeño para el chat flotante */
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 8px;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            margin-bottom: 10px;
            background-color: #fff;
            color: #333;
        }

        #ai-clarifier-chat textarea::placeholder {
            color: #aaa; /* Color más claro para el placeholder */
        }

        #ai-clarifier-chat button {
            background-color: #dc3545; /* Rojo para el botón de IA */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%; /* Ocupa todo el ancho */
        }

        #ai-clarifier-chat button:hover {
            background-color: #c82333; /* Rojo más oscuro para hover */
            transform: translateY(-2px);
        }

        #ai-clarifier-chat #ai-clarifier-response {
            background-color: #ffffff; /* Fondo blanco para las respuestas */
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #eee; /* Borde sutil */
            white-space: pre-wrap;
            color: #283593; /* Texto azul oscuro */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #ai-clarifier-chat .gemini-logo {
            width: 40px; /* Tamaño más pequeño para el logo al lado del título */
            height: auto;
            vertical-align: middle;
            margin-top: -5px; /* Ajuste para alinear con el texto */
        }
        
        /* Spinner de carga */
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
            color: #dc3545; /* Rojo para el spinner */
        }

        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        /* Estilo del botón flotante de IA (para abrir/cerrar el chat flotante) */
        #floating-ai-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00bcd4; /* Celeste */
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            cursor: pointer;
            z-index: 1061; /* Por encima del chat flotante */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none;
        }

        #floating-ai-button:hover {
            background-color: #0097a7; /* Celeste más oscuro al pasar el cursor */
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* Contador de visitas (display: none en todas las pantallas ya que se elimina la funcionalidad) */
        .visit-counter {
            display: none; 
        }

        /* Ventana roja sutil de aparición/desaparición */
        .subtle-response-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(220, 53, 69, 0.2); /* Rojo suave, 20% opacidad */
            color: #dc3545; /* Color del texto rojo */
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            z-index: 10; /* Asegurarse de que esté por encima del contenido normal */
            pointer-events: none; /* Permite hacer clic a través de ella */
        }

        .subtle-response-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) { /* Móvil: Diseño de una columna */
            .navbar-custom {
                padding: 1rem 5%;
            }
            .navbar-custom .navbar-brand {
                font-size: 1.5rem; /* Texto más pequeño para móvil */
                margin-right: 0;
            }
            .navbar-custom .navbar-brand .brand-text {
                display: flex;
                flex-direction: column; /* Apila el texto */
                line-height: 1.2; /* Ajusta el interlineado */
            }
            .navbar-brand img {
                height: 35px; /* Ajusta el tamaño del logo para móvil */
                margin-right: 0px; /* Elimina margen a la derecha en móvil si el texto se apila */
                margin-left: 10px; /* Mantiene margen a la izquierda */
            }
            .navbar-custom .navbar-collapse {
                background-color: #171b4a; /* Azul oscuro para el menú colapsado */
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                backdrop-filter: blur(5px); /* Desenfoque para el menú colapsado */
                -webkit-backdrop-filter: blur(5px);
            }
            .navbar-custom .nav-link {
                text-align: center;
                margin: 5px 0;
            }
            .navbar-custom .nav-link::after {
                width: 50%;
            }
            /* Relleno de contenido principal ajustado para móvil */
            .main-content {
                padding: 15px 2%;
                padding-top: 90px; /* Ajuste para el banner fijo en móvil */
            }
            .main-content h1, .main-content h2, .main-content h3,
            .main-content h4, .main-content h5, .main-content h6 {
                font-size: 1.5rem;
            }
            #dynamic-install-banner {
                display: flex; /* Mostrar banner de instalación dinámico en móvil */
            }
            #dynamic-install-banner p {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            #dynamic-install-banner button {
                padding: 8px 15px;
            }
            /* Ajustar tamaño de fuente de pregunta de examen para pantallas pequeñas */
            .question-card h5 {
                font-size: 0.9em;
            }
            /* Ajustar tamaño de fuente de alternativa para pantallas pequeñas */
            .form-check-label.option-button {
                font-size: 0.8em;
            }

            /* Clarificador flotante reducido en móvil */
            #ai-clarifier-chat {
                width: 90%; /* Más ancho en móvil */
                height: 50vh; /* La mitad de la altura de la pantalla */
                left: 5%; /* Centrar horizontalmente */
                right: 5%;
                bottom: 15px;
                padding: 15px;
            }

            #floating-ai-button {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                bottom: 15px;
                right: 15px;
                display: flex; /* Asegurarse de que esté visible en móvil */
            }
        }

        @media (min-width: 769px) { /* PC: Layout principal de una columna, chat flotante a la derecha */
            body {
                flex-direction: column; /* Restablecer a columna para PC */
            }
            .content-container {
                display: block; /* No usar flexbox para el contenedor principal */
                width: 100%;
            }
            .main-content {
                width: auto; /* Ocupa el ancho natural */
                padding-right: 8%; /* Restablecer padding normal */
            }
            /* Ocultar el banner de instalación dinámico en PC */
            #dynamic-install-banner {
                display: none !important;
            }

            /* Clarificador flotante en PC */
            #ai-clarifier-chat {
                position: fixed; /* Mantiene la posición fija */
                bottom: 20px;
                right: 20px;
                width: 350px; /* Ancho para PC */
                height: 450px; /* Alto para PC */
                display: none; /* Oculto por defecto, se muestra con el botón flotante */
            }
            #ai-clarifier-chat .chat-header h2 {
                font-size: 1.0rem; /* Tamaño de fuente más pequeño para PC */
            }

            #floating-ai-button {
                display: flex; /* Asegurarse de que esté visible en PC */
            }
        }
    </style>
</head>
<body>

    <div class="background-overlay"></div>

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top" id="mainNavbar">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="#">
                <span class="brand-text">Seguridad<br>Privada</span>
                <img src="logoSec.png" alt="Logo Seguridad Privada">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#exam-section">Examen OS-10</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#interes">Links de Interés</a>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <button class="search-toggler" id="searchToggle">
                            <i class="bi bi-search"></i>
                        </button>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <a class="contact-btn" href="#contacto">
                            <i class="bi bi-person"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="search-bar-container" id="searchBar">
            <input type="text" placeholder="Buscar en la página..." aria-label="Search">
        </div>
    </nav>

    <div class="main-content">
        <h1 class="text-center">¡Bienvenido a la Plataforma de Seguridad Privada en Chile!</h1>
        <p>Esta plataforma ha sido diseñada para ofrecerte información relevante y actualizada sobre la normativa de seguridad privada en Chile, incluyendo la nueva Ley 21.659, decretos complementarios y material de estudio esencial para guardias de seguridad y vigilantes privados. Nuestro objetivo es ayudarte a comprender mejor tus responsabilidades y derechos en esta importante labor, promoviendo la excelencia y el cumplimiento normativo.</p>

        <section id="exam-section" class="mt-5">
            <h2 class="text-center">Examen de Preparación OS-10</h2>
            <p class="text-center">Pon a prueba tus conocimientos sobre la normativa de seguridad privada y las funciones del guardia. ¡Obtén tu calificación en escala del 1 al 7, basada en el curso OS-10!</p>
            
            <button id="start-exam-btn" class="mb-4">Empezar Examen Ahora</button>

            <div id="quiz-container" class="mt-4">
                <p class="text-center text-info">Cargando preguntas del examen...</p>
            </div>
            <div class="exam-controls">
                <button id="submit-quiz-btn" style="display: none;">Enviar Examen</button>
            </div>
            <div id="exam-results" class="mt-4">
                </div>
            <div id="subtle-response-box" class="subtle-response-box">
                ¡El examen está listo para comenzar!
            </div>
        </section>

        <section class="info-section">
            <h2 id="interes">Links de Interés</h2>
            <p>Aquí encontrarás enlaces a recursos útiles para complementar tu conocimiento y formación en seguridad privada.</p>
            <ul>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.dt.gob.cl/" target="_blank">Dirección del Trabajo</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.zosepcar.cl/OS10.php" target="_blank">Zosepcar OS-10</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://dal5.short.gy/CFil" target="_blank">Cerofilas</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.bcn.cl/leychile/navegar?idNorma=1200633" target="_blank">Decreto 32 Exento</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://dal5.short.gy/LeySeg" target="_blank">LEY 21.659 - Ministerio del Interior y Seguridad Pública</a></li>
            </ul>

            <h3>Videos Educativos</h3>
            <p>Explora videos tutoriales y explicaciones sobre procedimientos y normativas de seguridad privada.</p>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/rfJQ1bVuTKk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </section>

        <section class="info-section">
            <h2 id="contacto">Contacto</h2>
            <p>Si tienes preguntas o necesitas más información, no dudes en contactarnos. Estamos aquí para ayudarte a ser un profesional de seguridad mejor informado y capacitado.</p>
            <address class="text-center">
                <strong>Daniel Elías Figueroa Chacama</strong><br>
                Ingeniero en Informática<br>
                Chile
            </address>
        </section>

        <!-- Nueva sección para el Asistente de Redacción de Informes -->
        <section id="report-assistant-section" class="info-section mt-5">
            <h2 class="text-center">Asistente de Redacción de Informes y Comunicaciones ✨</h2>
            <p class="text-center">Describe brevemente el incidente o la situación, y la IA te ayudará a redactar un borrador de informe o comunicación profesional.</p>
            
            <div class="mb-3 text-center">
                <img src="gemini.png" alt="Logo de Gemini IA" class="gemini-logo" style="width: 60px; height: auto;">
            </div>

            <textarea id="incident-description-input" class="form-control mb-3" rows="5" placeholder="Ej: Hubo un hurto en la tienda. Un hombre con camisa azul tomó un objeto y salió corriendo."></textarea>
            
            <select id="report-type-select" class="form-select mb-3">
                <option value="informe_interno">Informe Interno de Incidente</option>
                <option value="comunicacion_policial">Comunicación a Carabineros</option>
                <option value="correo_supervisor">Correo a Supervisor</option>
                <option value="reporte_general">Reporte General de Evento</option>
                <option value="acta_detencion_particulares">Acta de Detención por Particulares</option>
            </select>

            <button id="generate-report-btn" class="btn btn-primary w-100 mb-3" style="background-color: #283593; border-color: #283593; color: white;">Generar Borrador</button>
            
            <div id="report-output" class="p-3 bg-light rounded" style="min-height: 150px; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; font-size: 0.9em; color: #333;">
                El borrador del informe aparecerá aquí.
            </div>
            <button id="copy-report-btn" class="btn btn-outline-secondary mt-3" style="display: none;">Copiar a Portapapeles</button>
        </section>
    </div>

    <div id="floating-ai-button" aria-label="Abrir Clarificador de Inteligencia Artificial">
        <i class="bi bi-robot"></i> </div>

    <div id="ai-clarifier-chat" class="ai-clarifier-chat">
        <div class="chat-header">
            <h2>Clarificador IA</h2>
            <img src="gemini.png" alt="Logo de Gemini IA" class="gemini-logo">
            <button class="close-button" id="close-ai-chat">×</button>
        </div>
        <div class="chat-content">
            <p>¿Tienes dudas sobre algún artículo o normativa? Escribe tu pregunta y te ayudaremos.</p>
            <textarea id="ai-question-input" placeholder="Ej: ¿Qué dice el Decreto 93 sobre los requisitos de educación de un Guardia de Seguridad?"></textarea>
            <button id="ask-ai-btn">Preguntar a la IA</button>
            <div id="ai-clarifier-response" class="mt-3">
                <p>Tu respuesta aparecerá aquí.</p>
            </div>
        </div>
    </div>


    <footer class="footer">
        <p>Plataforma creada por Daniel Elías Figueroa Chacama, Ingeniero en Informática.</p>
        <p>© 2025 Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let deferredInstallPrompt = null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM Content Loaded. Initializing app logic.");

            // Navbar Shrink on Scroll
            const navbar = document.getElementById('mainNavbar');
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    navbar.classList.add('navbar-shrink');
                } else {
                    navbar.classList.remove('navbar-shrink');
                }
            });

            // Search Bar Toggle
            const searchToggle = document.getElementById('searchToggle');
            const searchBar = document.getElementById('searchBar');

            // Add event listener for search toggle
            searchToggle.addEventListener('click', function() {
                searchBar.classList.toggle('show');
            });

            // Hide search bar if clicked outside
            document.addEventListener('click', function(event) {
                // Check if the click is outside the search bar and the toggle button
                if (!searchBar.contains(event.target) && !searchToggle.contains(event.target)) {
                    searchBar.classList.remove('show');
                }
            });


            // --- Lógica del Banner de Instalación PWA (Creado dinámicamente) ---
            let dynamicInstallBanner = null;
            let bannerTimeout;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredInstallPrompt = e;
                
                if (!dynamicInstallBanner && window.matchMedia('(max-width: 768px)').matches && !window.matchMedia('(display-mode: standalone)').matches) {
                    dynamicInstallBanner = document.createElement('div');
                    dynamicInstallBanner.id = 'dynamic-install-banner';
                    dynamicInstallBanner.innerHTML = `
                        ¿Quieres instalar esta app? 
                        <button>Instalar</button>
                    `;
                    document.body.appendChild(dynamicInstallBanner);

                    dynamicInstallBanner.querySelector('button').addEventListener('click', () => {
                        clearTimeout(bannerTimeout);
                        if (deferredInstallPrompt) {
                            deferredInstallPrompt.prompt();
                            deferredInstallPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('Usuario aceptó la instalación');
                                } else {
                                    console.log('Usuario rechazó la instalación');
                                }
                                deferredInstallPrompt = null;
                                if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                                    dynamicInstallBanner.remove();
                                }
                            });
                        } else {
                            console.log('deferredPrompt no disponible. El navegador no mostró el prompt de instalación.');
                            if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                                dynamicInstallBanner.remove();
                            }
                        }
                    });

                    bannerTimeout = setTimeout(() => {
                        if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                            dynamicInstallBanner.remove();
                            console.log('Banner de instalación eliminado después de 10 segundos.');
                        }
                    }, 10000);

                    window.addEventListener('scroll', () => {
                        if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                            dynamicInstallBanner.remove();
                            clearTimeout(bannerTimeout);
                            console.log('Banner de instalación eliminado por scroll.');
                        }
                    }, { once: true });
                }
                console.log('beforeinstallprompt event fired. PWA is installable.');
            });

            window.addEventListener('appinstalled', () => {
                if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                    dynamicCacheBanner.remove();
                }
                console.log('PWA fue instalada exitosamente.');
            });

            // --- Lógica del Examen ---
            const quizContainer = document.getElementById('quiz-container');
            const submitQuizBtn = document.getElementById('submit-quiz-btn');
            const examResults = document.getElementById('exam-results');
            const startExamBtn = document.getElementById('start-exam-btn');
            const examSection = document.getElementById('exam-section'); // Obtener la sección del examen
            const subtleResponseBox = document.getElementById('subtle-response-box'); 

            quizContainer.style.display = 'none';
            if (subtleResponseBox) {
                subtleResponseBox.style.display = 'none'; // Ocultar por defecto
            }

            // Preguntas predeterminadas para respaldo (Verdadero/Falso)
            const defaultQuestions = [
                {
                    question: "La Autoridad Fiscalizadora de la Seguridad Privada en Chile es la Prefectura de Carabineros de Chile del sector.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La Ley N° 21.659, publicada en marzo de 2024, es la única ley que regula la seguridad privada en Chile actualmente.",
                    correctAnswer: "Falso" // Porque el Decreto 93 aún es relevante para ciertas interpretaciones hasta la plena vigencia de la nueva ley.
                },
                {
                    question: "La seguridad privada, según las normativas vigentes antes de la Ley 21.659, busca reemplazar a la seguridad pública.",
                    correctAnswer: "Falso"
                },
                {
                    question: "Uno de los requisitos para ser Guardia de Seguridad según el Decreto 93 es tener 18 años.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Los Guardias de Seguridad están autorizados para portar armas de fuego en el ejercicio de sus funciones según el Decreto 93.",
                    correctAnswer: "Falso"
                },
                {
                    question: "El curso de formación para Guardia de Seguridad, según el Decreto 93, tiene una duración de 90 horas.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "El seguro de vida para Guardias de Seguridad, según el Decreto 93, tiene una cifra asegurada de 75 UTM.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "El uniforme de un Guardia de Seguridad, según el Decreto 93, es libre y sin especificaciones de color.",
                    correctAnswer: "Falso" // Tenía especificaciones, aunque menos estrictas que el vigilante.
                },
                {
                    question: "Un Guardia de Seguridad está facultado para detener a alguien solo en caso de sorprenderlo en delito flagrante.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Delito es toda acción u omisión VOLUNTARIA penada por la Ley.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Cuasidelito es toda acción u omisión INVOLUNTARIA, penada por la ley.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La diferencia entre robo y hurto es que el robo se comete con violencia, intimidación o fuerza en las cosas, mientras que el hurto no.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La legítima defensa es aplicable solo si existe presencia policial en el momento de la agresión.",
                    correctAnswer: "Falso"
                },
                {
                    question: "El sitio del suceso debe ser preservado y no alterado para la investigación.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Una ronda fija se caracteriza por tener la hora y el trayecto preestablecidos.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Los Guardias de Seguridad deben proteger personas y bienes, siendo la vida del guardia la más importante.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Ante el hallazgo de un artefacto explosivo, la primera acción debe ser intentar desactivarlo si se tienen conocimientos.",
                    correctAnswer: "Falso"
                },
                {
                    question: "Una evacuación es el traslado ordenado de personas hacia una zona de seguridad designada.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Una Directiva de Funcionamiento es un documento que señala el funcionamiento íntegro de los guardias de seguridad.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "El Estudio de Seguridad es aprobado por la Prefectura de Carabineros del sector.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "El porte ilegal de armas es portar un arma en la vía pública sin autorización.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La Subsecretaría de Telecomunicaciones (SUBTEL) es la entidad que autoriza el uso de radiocomunicaciones en seguridad privada.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "En un supermercado, un guardia puede detener a una persona por consumir un alimento antes de pasar por caja, incluso si no ha salido del establecimiento.",
                    correctAnswer: "Falso"
                },
                {
                    question: "El secuestro es el traslado o retención de una o más personas sin su consentimiento.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La misión de Carabineros de Chile incluye garantizar el Orden y la Seguridad Pública.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Escalamiento es ingresar a una propiedad por una vía no destinada al efecto.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "La función principal de una antena en un transceptor portátil es amplificar el sonido.",
                    correctAnswer: "Falso"
                },
                {
                    question: "El contacto magnético es un sistema de alarma utilizado en puertas y ventanas para detectar aperturas.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Los daños físicos y psíquicos sufridos por un guardia en el cumplimiento de sus funciones se consideran actos del servicio y pueden derivar en enfermedades profesionales.",
                    correctAnswer: "Verdadero"
                },
                {
                    question: "Para ser Guardia de Seguridad, se requiere haber cursado educación básica completa.",
                    correctAnswer: "Falso" // Requiere 8º básico aprobado y curso OS-10.
                }
            ];
            
            let questions = [];

            // Función para generar preguntas usando la API de Gemini
            async function generateQuestions() {
                console.log("generateQuestions function called.");
                quizContainer.innerHTML = '<p class="text-center text-info"><span class="spinner-border text-info" role="status"></span> Generando preguntas con IA... Esto puede tardar unos segundos.</p>';
                quizContainer.style.display = 'block';
                startExamBtn.style.display = 'none';

                // Activar el borde rojo persistente para la sección de examen
                examSection.classList.add('active-red-border');

                // Mostrar ventana sutil con mensaje de carga
                if (subtleResponseBox) { 
                    subtleResponseBox.style.display = 'block';
                    subtleResponseBox.classList.add('show');
                    subtleResponseBox.textContent = '¡Generando preguntas, por favor espera!';
                }

                // Prompt actualizado para enfocarse en Decreto 93 y Decreto Ley 3607 para Guardias de Seguridad.
                const prompt = "Genera 30 preguntas de Verdadero/Falso sobre la normativa de seguridad privada en Chile ANTERIOR a la Ley 21.659, específicamente enfocadas en el Decreto Ley 3607 y el Decreto Supremo 93, y relativas a las funciones y requisitos de los GUARDIAS DE SEGURIDAD. Cada pregunta debe tener una única respuesta correcta: 'Verdadero' o 'Falso'. El formato debe ser un arreglo de objetos JSON, donde cada objeto tenga 'question' y 'correctAnswer' (el string 'Verdadero' o 'Falso').";
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "correctAnswer": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "correctAnswer"]
                            }
                        }
                    }
                };

                try {
                    console.log("Attempting to generate questions with Gemini API...");
                    const apiKey = "AIzaSyCUMr9SRpaPJEmB1dhG_g67GZtT8n4_3CI"; // TU CLAVE DE API PROPORCIONADA
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error al generar preguntas con Gemini API:', response.status, response.statusText, errorData);
                        quizContainer.innerHTML = '<p class="text-danger text-center">Error al cargar las preguntas de la IA. Usando preguntas de respaldo. (Código de estado: ' + response.status + ')</p>';
                        if (subtleResponseBox) subtleResponseBox.textContent = 'Error al cargar preguntas. Usando respaldo.';
                        questions = defaultQuestions;
                        console.log("Using default questions due to API error.");
                        displayQuiz();
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        console.log("Gemini API response (raw text):", jsonText);
                        
                        try {
                            questions = JSON.parse(jsonText);
                            if (!Array.isArray(questions) || questions.length === 0) {
                                console.warn("La API de Gemini devolvió un arreglo de preguntas inválido o vacío. Usando preguntas de respaldo.");
                                quizContainer.innerHTML = '<p class="text-danger text-center">La IA no generó preguntas válidas. Usando preguntas de respaldo.</p>';
                                if (subtleResponseBox) subtleResponseBox.textContent = 'IA no generó preguntas válidas. Usando respaldo.';
                                questions = defaultQuestions;
                                console.log("Using default questions due to invalid/empty JSON.");
                            } else if (questions.length < 30) {
                                console.warn(`Gemini generó ${questions.length} preguntas. Volviendo a las preguntas predeterminadas para asegurar 30 disponibles.`);
                                quizContainer.innerHTML = '<p class="text-warning text-center">IA generó pocas preguntas. Usando respaldo.</p>';
                                if (subtleResponseBox) subtleResponseBox.textContent = 'IA generó pocas preguntas. Usando respaldo.';
                                questions = defaultQuestions;
                                console.log("Using default questions because not enough were generated.");
                            }
                            displayQuiz();
                            if (subtleResponseBox) {
                                subtleResponseBox.textContent = '¡Preguntas cargadas! ¡Mucha suerte!';
                                setTimeout(() => {
                                    subtleResponseBox.classList.remove('show');
                                    setTimeout(() => subtleResponseBox.style.display = 'none', 500); // Esperar que la transición termine
                                }, 3000); // Mostrar por 3 segundos
                            }
                        } catch (parseError) {
                            console.error('Error al parsear la respuesta JSON de Gemini:', parseError);
                            quizContainer.innerHTML = '<p class="text-danger text-center">Error al procesar preguntas de la IA. Usando preguntas de respaldo.</p>';
                            if (subtleResponseBox) subtleResponseBox.textContent = 'Error al procesar preguntas. Usando respaldo.';
                            questions = defaultQuestions;
                            console.log("Using default questions due to JSON parsing error.");
                            displayQuiz();
                        }
                    } else {
                        console.warn("La estructura de la respuesta de la API de Gemini es inesperada (faltan partes del contenido). Usando fallback questions.");
                        quizContainer.innerHTML = '<p class="text-danger text-center">Estructura de respuesta de IA inesperada. Usando preguntas de respaldo.</p>';
                        if (subtleResponseBox) subtleResponseBox.textContent = 'Respuesta IA inesperada. Usando respaldo.';
                        questions = defaultQuestions;
                        console.log("Using default questions due to unexpected API response structure.");
                        displayQuiz();
                    }
                } catch (error) {
                    console.error('Error de red o parseo al llamar a Gemini (generar preguntas):', error);
                    quizContainer.innerHTML = '<p class="text-danger text-center">Error de conexión al generar las preguntas. Usando preguntas de respaldo.!</p>';
                    if (subtleResponseBox) subtleResponseBox.textContent = 'Error de conexión. Usando respaldo.';
                    questions = defaultQuestions;
                    console.log("Using default questions due to network/parsing error.");
                    displayQuiz();
                } finally {
                    // Si el mensaje no fue ocultado por éxito, ocultarlo después de un tiempo si hubo error
                    if (subtleResponseBox && subtleResponseBox.classList.contains('show')) {
                        setTimeout(() => {
                            subtleResponseBox.classList.remove('show');
                            setTimeout(() => subtleResponseBox.style.display = 'none', 500);
                        }, 5000); // Mantener un poco más si hubo error
                    }
                }
            }

            // Función para mostrar las preguntas del examen
            function displayQuiz() {
                quizContainer.innerHTML = ''; // Limpiar mensaje de carga
                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.classList.add('question-card');
                    questionCard.innerHTML = `
                        <h5>${index + 1}. ${q.question}</h5>
                        <div class="options-container">
                            <label class="option-button">
                                <input class="form-check-input" type="radio" name="question${index}" value="Verdadero">
                                Verdadero
                            </label>
                            <label class="option-button">
                                <input class="form-check-input" type="radio" name="question${index}" value="Falso">
                                Falso
                            </label>
                        </div>
                    `;
                    quizContainer.appendChild(questionCard);

                    // Add event listeners to custom buttons
                    const radioButtons = questionCard.querySelectorAll(`input[name="question${index}"]`);
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', function() {
                            // Remove 'selected' class from all buttons for this question
                            radioButtons.forEach(innerRadio => {
                                innerRadio.closest('.option-button').classList.remove('selected');
                            });
                            // Add 'selected' class to the parent label of the checked radio button
                            this.closest('.option-button').classList.add('selected');
                            // Add blue border to the question card
                            questionCard.classList.add('answered-blue-border');
                        });
                    });
                });
                quizContainer.style.display = 'block'; // Mostrar contenedor del examen
                submitQuizBtn.style.display = 'block'; // Mostrar botón de enviar
                console.log("Quiz questions displayed.");
            }

            // Función para enviar el examen y calcular la puntuación
            function submitQuiz() {
                let score = 0;
                questions.forEach((q, index) => {
                    const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                    if (selectedOption && selectedOption.value === q.correctAnswer) {
                        score++;
                    }
                });

                const maxScore = questions.length;
                const percentage = (score / maxScore) * 100;
                const grade = calculateGrade(percentage);

                examResults.innerHTML = `
                    <h3>Resultados del Examen</h3>
                    <p>Respuestas correctas: ${score} de ${maxScore}</p>
                    <p>Porcentaje: ${percentage.toFixed(2)}%</p>
                    <p>Tu nota en escala del 1 al 7: <strong style="color: #1a237e;">${grade.toFixed(1)}</strong></p>
                    ${grade >= 4.0 ? '<p class="text-success">¡Felicitaciones! Has aprobado.</p>' : '<p class="text-danger">Necesitas repasar más. ¡No te desanimes!</p>'}
                `;
                examResults.style.display = 'block';
                submitQuizBtn.style.display = 'none'; // Ocultar botón de enviar después del envío
                quizContainer.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = true); // Desactivar opciones después del envío
                console.log("Quiz submitted and results displayed. Score:", score);
            }

            // Función para calcular la calificación de 1 a 7
            function calculateGrade(percentage) {
                if (percentage < 30) return 1.0;
                if (percentage < 40) return 2.0;
                if (percentage < 50) return 3.0;
                if (percentage < 60) return 4.0;
                if (percentage < 70) return 5.0;
                if (percentage < 85) return 6.0;
                return 7.0;
            }

            // Event listener para el nuevo botón "Empezar Examen Ahora"
            startExamBtn.addEventListener('click', generateQuestions);

            submitQuizBtn.addEventListener('click', submitQuiz);

            // --- Lógica del Clarificador IA (Flotante) ---
            const floatingAiButton = document.getElementById('floating-ai-button');
            const aiClarifierChat = document.getElementById('ai-clarifier-chat');
            const closeAiChatBtn = document.getElementById('close-ai-chat');
            const aiQuestionInput = document.getElementById('ai-question-input');
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiClarifierResponse = document.getElementById('ai-clarifier-response');

            floatingAiButton.addEventListener('click', () => {
                console.log("Floating AI button clicked. Toggling chat visibility.");
                aiClarifierChat.classList.toggle('show');
            });

            closeAiChatBtn.addEventListener('click', () => {
                console.log("Close chat button clicked. Hiding chat.");
                aiClarifierChat.classList.remove('show');
                aiQuestionInput.value = ''; // Limpiar input al cerrar
                aiClarifierResponse.innerHTML = '<p>Tu respuesta aparecerá aquí.</p>'; // Resetear respuesta
            });

            askAiBtn.addEventListener('click', async function() {
                const userQuestion = aiQuestionInput.value.trim();
                if (userQuestion === "") {
                    aiClarifierResponse.innerHTML = '<p class="text-danger">Por favor, escribe tu pregunta.</p>';
                    return;
                }

                aiClarifierResponse.innerHTML = '<p class="text-info"><span class="spinner-border text-info" role="status"></span> Cargando respuesta de la IA... Esto puede tardar unos segundos.</p>';
                askAiBtn.disabled = true;
                console.log("Ask AI button clicked. Sending prompt to Gemini for clarification.");

                // Actualizar el prompt para incluir la fecha de vigencia de la Ley 21.659
                // Y para que responda texto plano.
                const prompt = `Como un experto en la normativa de seguridad privada de Chile ANTERIOR a la Ley 21.659 (específicamente Decreto Ley 3607 y Decreto Supremo 93), explica lo siguiente de manera clara, concisa y enfocada en las funciones y requisitos de GUARDIAS DE SEGURIDAD: "${userQuestion}". Proporciona solo la respuesta directa y relevante, sin incluir ningún encabezado, pie de página o formato de código (ej. \`\`\`json\`\`\`, \`\`\`text\`\`\`, etc.) o marcas de viñetas innecesarias si la respuesta es un solo párrafo. Ten en cuenta que si la pregunta es sobre la entrada en vigencia de la Ley 21.659, la fecha es 28-NOV-2025.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                // No especificar responseMimeType: "application/json" para obtener texto plano
                const payload = { contents: chatHistory };

                try {
                    console.log("Attempting to get AI clarification with Gemini API for user question:", userQuestion);
                    const apiKey = "AIzaSyCUMr9SRpaPJEmB1dhG_g67GZtT8n4_3CI"; // TU CLAVE DE API PROPORCIONADA
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error al obtener datos de la API de Gemini para aclaración:', response.status, response.statusText, errorData);
                        aiClarifierResponse.innerHTML = `<p class="text-danger">Hubo un error (${response.status}) al obtener la respuesta de la IA. Por favor, inténtalo de nuevo.</p>`;
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        let text = result.candidates[0].content.parts[0].text;
                        // Eliminar cualquier bloque de código o texto residual si la IA lo incluyera
                        text = text.replace(/```json\n?[\s\S]*?\n?```/, '').trim();
                        text = text.replace(/```\n?[\s\S]*?\n?```/, '').trim();
                        aiClarifierResponse.innerHTML = `<p>${text}</p>`;
                        console.log("AI clarification received and displayed.");
                    } else {
                        console.warn("La estructura de la respuesta de la API de Gemini para aclaración es inesperada o está vacía.");
                        aiClarifierResponse.innerHTML = '<p class="text-warning">No se pudo obtener una respuesta clara de la IA. Intenta reformular tu pregunta.</p>';
                    }
                } catch (error) {
                    console.error('Network error or parsing issue in Gemini API call for clarification:', error);
                    aiClarifierResponse.innerHTML = '<p class="text-danger">Error de conexión al Clarificador IA. Asegúrate de tener acceso a internet y que el servicio esté disponible.</p>';
                } finally {
                    askAiBtn.disabled = false;
                    console.log("AI Clarifier request finished.");
                }
            });

            // --- Lógica del Asistente de Redacción de Informes ---
            const incidentDescriptionInput = document.getElementById('incident-description-input');
            const reportTypeSelect = document.getElementById('report-type-select');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const reportOutput = document.getElementById('report-output');
            const copyReportBtn = document.getElementById('copy-report-btn');

            generateReportBtn.addEventListener('click', async () => {
                const description = incidentDescriptionInput.value.trim();
                const selectedReportType = reportTypeSelect.value;

                if (!description) {
                    reportOutput.innerHTML = '<p class="text-danger">Por favor, describe el incidente.</p>';
                    return;
                }

                reportOutput.innerHTML = '<p class="text-info"><span class="spinner-border text-info" role="status"></span> Generando borrador...</p>';
                generateReportBtn.disabled = true;
                copyReportBtn.style.display = 'none';

                let promptText = "";
                // Base prompt for report generation
                const basePrompt = `Eres un asistente de IA especializado en generar borradores de comunicaciones profesionales para personal de seguridad privada en Chile, basándote en el contexto del incidente. Tu objetivo es redactar informes claros, concisos y objetivos, utilizando la normativa chilena relevante para guardias de seguridad (específicamente Decreto Ley 3607 y Decreto Supremo 93, y NO las nuevas Ley 21.659 o Decreto 209).`;

                switch (selectedReportType) {
                    case 'informe_interno':
                        promptText = `${basePrompt} Genera un Informe Interno de Incidente. Extrae la siguiente información de la descripción del usuario y formatéala en secciones claras, sin preámbulos ni conclusiones conversacionales: Fecha y Hora (DD/MM/AAAA HH:MM, si es posible, usa la fecha actual si no se especifica), Ubicación del Incidente, Tipo de Incidente (ej. Hurto, Robo, Acto sospechoso, Accidente, Incumplimiento normativo), Descripción Detallada del Evento (narrativa cronológica de lo ocurrido, acciones del guardia), Personal de Seguridad Involucrado (nombres, cargos, acciones iniciales), Acciones Tomadas (medidas inmediatas, notificaciones a autoridades como Carabineros si aplica, retenciones, etc.), Evidencia Recolectada (cámaras, testimonios, objetos), y Recomendaciones/Observaciones. Si la información no está en la descripción, indica 'No especificado'. Descripción: "${description}"`;
                        break;
                    case 'comunicacion_policial':
                        promptText = `${basePrompt} Redacta una Comunicación formal a Carabineros de Chile sobre el incidente. Incluye: Fecha, Hora, Lugar del Incidente, Tipo de Incidente, Descripción concisa del evento enfocándose en los hechos relevantes para la autoridad, y Acciones inmediatas tomadas por el guardia. Si la información no está en la descripción, indica 'No especificado'. No incluyas saludos ni despedidas, solo el cuerpo de la comunicación. Descripción: "${description}"`;
                        break;
                    case 'correo_supervisor':
                        promptText = `${basePrompt} Redacta un Correo Electrónico a un supervisor. Incluye: Asunto (claro y conciso), Fecha y Hora del Incidente, Breve resumen del evento, Acciones tomadas por el guardia, y si se requiere alguna acción o decisión adicional por parte del supervisor. No uses saludos ni despedidas conversacionales, solo el cuerpo del correo. Descripción: "${description}"`;
                        break;
                    case 'reporte_general':
                        promptText = `${basePrompt} Genera un Reporte General de Evento. Extrae: Fecha y Hora (usa la fecha actual si no se especifica), Ubicación, Naturaleza del Evento, Breve descripción de lo ocurrido, Personas afectadas/involucradas, y Medidas adoptadas por el guardia. Si la información no está en la descripción, indica 'No especificado'. No incluyas preámbulos ni conclusiones. Descripción: "${description}"`;
                        break;
                    case 'acta_detencion_particulares':
                        promptText = `${basePrompt} Redacta un Acta de Detención por Particulares para entregar a Carabineros de Chile. Incluye: Título (ACTA DE DETENCIÓN POR PARTICULARES), Fecha y Hora de la detención, Lugar de la Detención, Identificación del Detenido (si se conoce: Nombre Completo, Rut, Características Físicas), Motivo de la Detención (descripción concisa del delito flagrante), Objeto del Delito (si aplica), Testigos (si aplica), Identificación del Detenedor (Guardia de Seguridad: Nombre, Rut, Empresa), Hora de entrega a Carabineros (si aplica). El formato debe ser un texto claro, directo y sin preámbulos. Descripción del incidente por el usuario: "${description}". Referencia para formato de acta: https://dal5.short.gy/Act`;
                        break;
                }

                let chatHistory = [{ role: "user", parts: [{ text: promptText }] }];
                const payload = { contents: chatHistory }; // No responseMimeType here, default to text

                try {
                    const apiKey = "AIzaSyCUMr9SRpaPJEmB1dhG_g67GZtT8n4_3CI"; // Ya definida globalmente
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    console.log("Payload enviado a Gemini para informe:", payload); // Log para depuración

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error al generar informe con Gemini API:', response.status, response.statusText, errorData);
                        reportOutput.innerHTML = `<p class="text-danger">Error al generar el informe: ${errorData.error.message || 'Error desconocido'}.</p>`;
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        reportOutput.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding: 10px; border-radius: 5px; color: #333;">${generatedText}</pre>`;
                        copyReportBtn.style.display = 'block';
                    } else {
                        reportOutput.innerHTML = '<p class="text-warning">No se pudo generar un informe. Intenta con una descripción más detallada.</p>';
                    }
                } catch (error) {
                    console.error('Error de red o parseo al llamar a Gemini para informe:', error);
                    reportOutput.innerHTML = '<p class="text-danger">Error de conexión. Asegúrate de tener conexión a internet.</p>';
                } finally {
                    generateReportBtn.disabled = false;
                }
            });

            copyReportBtn.addEventListener('click', () => {
                const reportContent = reportOutput.textContent;
                navigator.clipboard.writeText(reportContent).then(() => {
                    alert('Borrador copiado al portapapeles.');
                }).catch(err => {
                    console.error('Error al copiar el borrador:', err);
                    alert('No se pudo copiar el borrador.');
                });
            });
        });
    </script>
</body>
</html>
