<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguridad Privada Chile</title>
    <!-- Favicon de ejemplo para evitar errores 404 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E%F0%9F%9B%A1%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Estilos Base */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            z-index: -1;
        }

        /* Navbar */
        .navbar-custom {
            background-color: rgba(23, 27, 74, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease-in-out;
            padding: 0.8rem 3%; /* Reducido de 1rem a 0.8rem para hacer banner menos grueso */
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .navbar-custom .navbar-brand {
            font-weight: 700;
            color: #ffffff;
            transition: font-size 0.3s ease-in-out;
            margin-right: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .navbar-brand .brand-text {
            font-size: 1.2rem; /* Reducido drásticamente de 1.8rem a 1.2rem */
            line-height: 1.2;
            text-transform: uppercase;
            font-weight: 700; /* Reducido de 800 a 700 */
            letter-spacing: 1px; /* Reducido de 1.5px a 1px */
        }

        /* Estilos Base del Logo */
        .navbar-brand .navbar-logo {
            height: 20px !important; /* Agrandado 5 veces: 4px x 5 = 20px */
            width: auto !important;
            margin-left: 5px !important; /* Agrandado: 1px x 5 = 5px */
            order: 1;
            display: inline-block !important;
        }

        .navbar-custom .nav-link {
            color: #ffffff !important;
            font-weight: 600;
            position: relative;
            text-decoration: none;
            transition: color 0.3s ease-in-out, text-decoration 0.3s ease-in-out;
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border-radius: 5px;
        }

        .navbar-custom .nav-link:hover {
            color: #b2b6dc !important;
        }

        .navbar-custom .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #b2b6dc;
            transition: width 0.3s ease-in-out;
        }

        .navbar-custom .nav-link:hover::after {
            width: 80%;
        }

        .navbar-shrink {
            padding: 0.4rem 3%; /* Reducido de 0.5rem a 0.4rem para banner encogido aún más delgado */
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            background-color: rgba(23, 27, 74, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .navbar-shrink .navbar-brand {
            font-size: 1.2rem;
        }

        .search-toggler {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-toggler:hover {
            transform: scale(1.08);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .search-toggler i {
            color: #ffffff;
            font-size: 1.2rem;
        }

        .search-bar-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #171b4a;
            padding: 10px 3%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }

        .search-bar-container.show {
            display: block;
        }

        .search-bar-container input {
            width: 100%;
            border-radius: 20px;
            border: 1px solid #333;
            padding: 8px;
            font-family: 'Poppins', sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }

        .search-bar-container input::placeholder {
            color: #666;
        }

        .contact-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out;
            margin-left: 10px;
        }

        .contact-btn:hover {
            transform: scale(1.08);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .contact-btn i {
            color: #ffffff;
            font-size: 1.2rem;
        }

        .navbar-toggler {
            border: none;
            border-radius: 0;
            padding: 0;
            background-color: transparent;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255,255,255,1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
            width: 1.5em;
            height: 1.5em;
        }

        /* Contenido Principal */
        .main-content {
            flex-grow: 1;
            padding: 20px 8%;
            text-align: justify;
            line-height: 1.6;
            color: #333;
            min-width: 0;
            padding-top: 100px;
        }

        .info-section {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .info-section:hover {
            border-color: #dc3545;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4), 0 0 15px rgba(220, 53, 69, 0.6);
        }

        #exam-section:hover {
            border-color: #dc3545;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4), 0 0 15px rgba(220, 53, 69, 0.6);
        }

        #exam-section.active-red-border {
            border-color: #dc3545;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.6), 0 0 20px rgba(220, 53, 69, 0.8);
        }

        .main-content h1, .main-content h2, .main-content h3,
        .main-content h4, .main-content h5, .main-content h6 {
            font-weight: 700;
            font-size: 2.0rem;
            margin-top: 1.7em;
            margin-bottom: 0.8em;
            text-align: center;
            color: #283593;
        }

        .main-content .exam-heading-green {
            color: #28a745;
        }

        .main-content p {
            margin-bottom: 1.5em;
        }

        .main-content a {
            font-weight: bold;
            color: #283593;
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease-in-out;
        }

        .main-content a:hover {
            color: #515ba6;
            text-decoration: underline;
        }

        .main-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .image-caption {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            margin-bottom: 20px;
        }

        .main-content ul {
            list-style: none;
            padding-left: 0;
            text-align: left;
        }

        .main-content ul li::before {
            content: "\2023";
            font-size: 1em;
            color: #283593;
            position: absolute;
            left: 0;
            top: 0.1em;
        }

        .main-content blockquote {
            background-color: rgba(40, 53, 147, 0.1);
            border-left: 5px solid #283593;
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 8px;
            font-style: italic;
            color: #515ba6;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 100%;
        }

        .video-container iframe,
        .video-container object,
        .video-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        .icon-small {
            font-size: 0.9em;
            vertical-align: middle;
            margin-right: 5px;
            color: #283593;
        }

        #dynamic-install-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #283593;
            color: white;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #dynamic-install-banner button {
            margin-left: 10px;
            padding: 8px 16px;
            background: #e8eaf6;
            color: #283593;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #dynamic-install-banner button:hover {
            background-color: #c5cae9;
            transform: translateY(-1px);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background-color: #171b4a;
            color: #f8f8f8;
            font-size: 0.9em;
            margin-top: 50px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
        }

        /* Estilos del Examen */
        #exam-section {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            min-height: 500px;
        }

        #start-exam-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            animation: jump 0.6s infinite alternate;
        }

        #start-exam-btn:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            animation: none;
        }

        @keyframes jump {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-10px);
            }
        }

        #quiz-container {
            text-align: left;
        }

        .question-card {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .question-card h5 {
            color: #333;
            font-weight: 700;
            font-size: 1.1em;
            text-align: justify;
            margin-bottom: 15px;
        }
        
        .option-button {
            display: inline-block;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            user-select: none;
        }

        .option-button:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .option-button.selected {
            background-color: #283593;
            color: white;
            border-color: #283593;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .option-button.correct {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option-button.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .question-card.answered-blue-border {
            border-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
        }

        .form-check-input[type="radio"] {
            display: none;
        }

        .form-check-label.option-button {
            width: auto;
        }

        .exam-controls {
            text-align: center;
            margin-top: 30px;
        }

        .exam-controls button {
            background-color: #283593;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .exam-controls button:hover {
            background-color: #1a237e;
            transform: translateY(-2px);
        }

        #exam-results {
            background-color: rgba(40, 53, 147, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
            border: 1px solid rgba(40,53,147,0.5);
            color: #e8eaf6;
        }

        #exam-results h3 {
            color: #e8eaf6;
        }

        #exam-results p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a237e;
            animation: pulse-grade 4s infinite;
        }

        @keyframes pulse-grade {
            0% { transform: scale(1); opacity: 1; text-shadow: 0 0 0px rgba(255, 255, 255, 0); }
            50% { transform: scale(1.05); opacity: 0.9; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
            100% { transform: scale(1); opacity: 1; text-shadow: 0 0 0px rgba(255, 255, 255, 0); }
        }

        .subtle-response-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            z-index: 10;
            pointer-events: none;
        }

        .subtle-response-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Modal de resultados */
        #results-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #results-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        #results-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 90%;
            width: 500px;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease-out;
        }

        #results-modal-overlay.show #results-modal-content {
            transform: translateY(0);
        }

        #results-modal-content.pass {
            background-color: rgba(40, 167, 69, 0.9);
            color: white;
        }

        #results-modal-content.fail {
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
        }

        #results-modal-content h3 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        #results-modal-content p {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        #results-modal-content #modal-grade {
            font-size: 4rem;
            font-weight: 900;
            color: inherit;
            animation: pulse-modal-grade 1.5s infinite alternate;
        }

        @keyframes pulse-modal-grade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.9; }
        }

        #results-modal-content button {
            margin-top: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #results-modal-content button:hover {
            background-color: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* Spinner */
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
            color: #dc3545;
        }

        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        /* Estilo del chat flotante de IA */
        #ai-clarifier-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 450px;
            background-color: #b3e5fc;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
            justify-content: space-between;
            z-index: 1060;
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(0,0,0,0.1);
            color: #333;
        }

        #ai-clarifier-chat.show {
            display: flex;
        }

        #ai-clarifier-chat .chat-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: relative;
        }

        #ai-clarifier-chat .chat-header h2 {
            font-size: 1.0rem;
            margin: 0;
            color: #283593;
            margin-right: 10px;
        }

        #ai-clarifier-chat .chat-header .close-button {
            position: absolute;
            top: -5px;
            right: 0px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #555;
            cursor: pointer;
            padding: 0;
        }

        #ai-clarifier-chat .chat-header .close-button:hover {
            color: #000;
        }

        #ai-clarifier-chat .chat-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        #ai-clarifier-chat .chat-content p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        #ai-clarifier-chat textarea {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 8px;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            margin-bottom: 10px;
            background-color: #fff;
            color: #333;
        }

        #ai-clarifier-chat textarea::placeholder {
            color: #aaa;
        }

        #ai-clarifier-chat button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
        }

        #ai-clarifier-chat button:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        #ai-clarifier-chat #ai-clarifier-response {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #eee;
            white-space: pre-wrap;
            color: #283593;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #ai-clarifier-chat .gemini-logo {
            width: 40px;
            height: auto;
            vertical-align: middle;
            margin-top: -5px;
        }

        /* Estilo del botón flotante de IA */
        #floating-ai-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00bcd4;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            cursor: pointer;
            z-index: 1061;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none;
        }

        #floating-ai-button:hover {
            background-color: #0097a7;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* Responsive para el chat flotante */
        @media (max-width: 768px) {
            #ai-clarifier-chat {
                width: 90%;
                height: 50vh;
                left: 5%;
                right: 5%;
                bottom: 15px;
                padding: 15px;
            }

            #floating-ai-button {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                bottom: 15px;
                right: 15px;
                display: flex;
            }
        }

        @media (min-width: 769px) {
            #ai-clarifier-chat {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 350px;
                height: 450px;
                display: none;
            }
            #ai-clarifier-chat .chat-header h2 {
                font-size: 1.0rem;
            }

            #floating-ai-button {
                display: flex;
            }
        }
        @media (max-width: 768px) {
            .navbar-custom {
                padding: 1rem 5%;
            }
            .navbar-custom .navbar-brand {
                font-size: 1.5rem;
                margin-right: 0;
            }
            .navbar-brand .navbar-logo {
                height: 85px; /* Aumentado de 65px a 85px para móvil */
                margin-left: 20px; /* Aumentado margen */
                margin-right: 0px;
            }
            .navbar-custom .navbar-collapse {
                background-color: #171b4a;
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            }
            .navbar-custom .nav-link {
                text-align: center;
                margin: 5px 0;
            }
            .navbar-custom .nav-link::after {
                width: 50%;
            }
            .main-content {
                padding: 15px 2%;
                padding-top: 90px;
            }
            .main-content h1, .main-content h2, .main-content h3,
            .main-content h4, .main-content h5, .main-content h6 {
                font-size: 1.5rem;
            }
            #dynamic-install-banner {
                display: flex;
            }
            #dynamic-install-banner p {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            #dynamic-install-banner button {
                padding: 8px 15px;
            }
            .question-card h5 {
                font-size: 0.9em;
            }
            .form-check-label.option-button {
                font-size: 0.8em;
            }

            #results-modal-content {
                max-width: 95%;
                width: auto;
                padding: 20px;
            }
            #results-modal-content h3 {
                font-size: 2rem;
            }
            #results-modal-content #modal-grade {
                font-size: 3rem;
            }
            #results-modal-content p {
                font-size: 1rem;
            }
        }

        @media (min-width: 769px) {
            body {
                flex-direction: column;
            }
            .content-container {
                display: block;
                width: 100%;
            }
            .main-content {
                width: auto;
                padding-right: 8%;
            }
            #dynamic-install-banner {
                display: none !important;
            }

            .navbar-custom .navbar-brand {
                font-size: 2.8rem; /* Aumentado de 2.2rem a 2.8rem para PC */
                flex-direction: row;
                white-space: nowrap;
                align-items: center;
                font-weight: 900; /* Más grueso en PC */
            }
            .navbar-brand .brand-text {
                display: inline;
                letter-spacing: 2px; /* Aumentado de 1px a 2px */
            }
            .navbar-brand .navbar-logo {
                height: 95px; /* Aumentado de 75px a 95px para PC */
                margin-left: 25px; /* Aumentado margen */
            }
            .mobile-only {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="background-overlay"></div>

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top" id="mainNavbar">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="#">
                <span class="brand-text">SEGURIDAD <br class="mobile-only">PRIVADA</span>
                <img src="logoSec.png" alt="Logo Seguridad Privada" class="navbar-logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#exam-section">Examen OS-10</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#interes">Links de Interés</a>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <button class="search-toggler" id="searchToggle">
                            <i class="bi bi-search"></i>
                        </button>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <a class="contact-btn" href="#contacto">
                            <i class="bi bi-person"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="search-bar-container" id="searchBar">
            <input type="text" placeholder="Buscar en la página..." aria-label="Search">
        </div>
    </nav>

    <div class="main-content">
        <h1 class="text-center">¡Bienvenido a la Plataforma de Seguridad Privada en Chile!</h1>
        <p>Esta plataforma ha sido diseñada para ofrecerte información relevante y actualizada sobre la normativa de seguridad privada en Chile, incluyendo la nueva Ley 21.659, decretos complementarios y material de estudio esencial para guardias de seguridad y vigilantes privados. Nuestro objetivo es ayudarte a comprender mejor tus responsabilidades y derechos en esta importante labor, promoviendo la excelencia y el cumplimiento normativo.</p>

        <section id="exam-section" class="mt-5">
            <h2 class="text-center exam-heading-green">Examen de Preparación OS-10</h2>
            <p class="text-center">Pon a prueba tus conocimientos sobre la normativa de seguridad privada y las funciones del guardia. ¡Obtén tu calificación en escala del 1 al 7, basada en el curso OS-10!</p>
            <p class="text-center" style="color: #dc3545; font-weight: 600; font-size: 0.9rem;">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>IMPORTANTE:</strong> Este examen consta de 30 preguntas. Una vez que selecciones una respuesta, no podrás cambiarla. Lee cuidadosamente antes de responder.
            </p>
            
            <button id="start-exam-btn" class="mb-4">Empezar Examen Ahora</button>

            <div id="quiz-container" class="mt-4" style="display: none;">
                <p class="text-center text-info">Cargando preguntas del examen...</p>
            </div>
            <div class="exam-controls">
                <button id="submit-quiz-btn" style="display: none;">Enviar Examen</button>
            </div>
            <div id="subtle-response-box" class="subtle-response-box">
                ¡El examen está listo para comenzar!
            </div>
        </section>

        <section class="info-section">
            <h2 id="interes">Links de Interés</h2>
            <p>Aquí encontrarás enlaces a recursos útiles para complementar tu conocimiento y formación en seguridad privada.</p>
            <ul>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.dt.gob.cl/" target="_blank">Dirección del Trabajo</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.zosepcar.cl/OS10.php" target="_blank">Zosepcar OS-10</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://dal5.short.gy/CFil" target="_blank">Cerofilas</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.bcn.cl/leychile/navegar?idNorma=1200633" target="_blank">Decreto 32 Exento</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://dal5.short.gy/LeySeg" target="_blank">LEY 21.659 - Ministerio del Interior y Seguridad Pública</a></li>
            </ul>

            <h3>Videos Educativos</h3>
            <p>Explora videos tutoriales y explicaciones sobre procedimientos y normativas de seguridad privada.</p>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/rfJQ1bVuTKk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </section>

        <!-- Nueva sección para el Asistente de Redacción de Informes -->
        <section id="report-assistant-section" class="info-section mt-5">
            <h2 class="text-center">Asistente de Redacción de Informes y Comunicaciones ✨</h2>
            <p class="text-center">Describe brevemente el incidente o la situación, y la IA te ayudará a redactar un borrador de informe o comunicación profesional.</p>
            
            <div class="mb-3 text-center">
                <img src="gemini.png" alt="Logo de Gemini IA" class="gemini-logo" style="width: 60px; height: auto;">
            </div>

            <textarea id="incident-description-input" class="form-control mb-3" rows="5" placeholder="Ej: Hubo un hurto en la tienda. Un hombre con camisa azul tomó un objeto y salió corriendo."></textarea>
            
            <select id="report-type-select" class="form-select mb-3">
                <option value="informe_interno">Informe Interno de Incidente</option>
                <option value="comunicacion_policial">Comunicación a Carabineros</option>
                <option value="correo_supervisor">Correo a Supervisor</option>
                <option value="reporte_general">Reporte General de Evento</option>
                <option value="acta_detencion_particulares">Acta de Detención por Particulares</option>
            </select>

            <button id="generate-report-btn" class="btn btn-primary w-100 mb-3" style="background-color: #283593; border-color: #283593; color: white;">Generar Borrador</button>
            
            <div id="report-output" class="p-3 bg-light rounded" style="min-height: 150px; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; font-size: 0.9em; color: #333;">
                El borrador del informe aparecerá aquí.
            </div>
            <button id="copy-report-btn" class="btn btn-outline-secondary mt-3" style="display: none;">Copiar a Portapapeles</button>
            <a id="download-acta-btn" href="https://dal5.short.gy/Act" target="_blank" download="Acta_Detencion_Particulares.pdf" class="btn btn-success mt-3" style="display: none;">Descargar Acta (PDF)</a>
        </section>

        <section class="info-section">
            <h2 id="contacto">Contacto</h2>
            <p>Si tienes preguntas o necesitas más información, no dudes en contactarnos. Estamos aquí para ayudarte a ser un profesional de seguridad mejor informado y capacitado.</p>
            <address class="text-center">
                <strong>Daniel Elías Figueroa Chacama</strong><br>
                Ingeniero en Informática<br>
                Chile
            </address>
        </section>
    </div>

    <!-- Modal de Resultados del Examen -->
    <div id="results-modal-overlay">
        <div id="results-modal-content">
            <h3>Resultados del Examen</h3>
            <p>Respuestas correctas: <span id="modal-correct-count"></span> de <span id="modal-total-questions"></span></p>
            <p>Porcentaje: <span id="modal-percentage"></span>%</p>
            <p>Tu nota en escala del 1 al 7: <strong id="modal-grade"></strong></p>
            <p id="modal-message"></p>
            <button id="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <!-- Botón flotante de IA -->
    <div id="floating-ai-button" aria-label="Abrir Clarificador de Inteligencia Artificial">
        <i class="bi bi-robot"></i>
    </div>

    <!-- Chat flotante del clarificador de IA -->
    <div id="ai-clarifier-chat" class="ai-clarifier-chat">
        <div class="chat-header">
            <h2>Clarificador IA</h2>
            <img src="gemini.png" alt="Logo de Gemini IA" class="gemini-logo">
            <button class="close-button" id="close-ai-chat">×</button>
        </div>
        <div class="chat-content">
            <p>¿Tienes dudas sobre algún artículo o normativa? Escribe tu pregunta y te ayudaremos.</p>
            <textarea id="ai-question-input" placeholder="Ej: ¿Qué dice el Decreto 93 sobre los requisitos de educación de un Guardia de Seguridad?"></textarea>
            <button id="ask-ai-btn">Preguntar a la IA</button>
            <div id="ai-clarifier-response" class="mt-3">
                <p>Tu respuesta aparecerá aquí.</p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Plataforma creada por Daniel Elías Figueroa Chacama, Ingeniero en Informática.</p>
        <p>© 2025 Todos los derechos reservados.</p>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded. Initializing app logic.");

            // Navbar Shrink on Scroll
            const navbar = document.getElementById('mainNavbar');
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    navbar.classList.add('navbar-shrink');
                } else {
                    navbar.classList.remove('navbar-shrink');
                }
            });

            // Search Bar Toggle
            const searchToggle = document.getElementById('searchToggle');
            const searchBar = document.getElementById('searchBar');

            searchToggle.addEventListener('click', function() {
                searchBar.classList.toggle('show');
            });

            document.addEventListener('click', function(event) {
                if (!searchBar.contains(event.target) && !searchToggle.contains(event.target)) {
                    searchBar.classList.remove('show');
                }
            });

            // --- Quiz Logic ---
            const quizContainer = document.getElementById('quiz-container');
            const submitQuizBtn = document.getElementById('submit-quiz-btn');
            const startExamBtn = document.getElementById('start-exam-btn');
            const examSection = document.getElementById('exam-section');
            const subtleResponseBox = document.getElementById('subtle-response-box');

            // Modal elements for results
            const resultsModalOverlay = document.getElementById('results-modal-overlay');
            const resultsModalContent = document.getElementById('results-modal-content');
            const modalCorrectCount = document.getElementById('modal-correct-count');
            const modalTotalQuestions = document.getElementById('modal-total-questions');
            const modalPercentage = document.getElementById('modal-percentage');
            const modalGrade = document.getElementById('modal-grade');
            const modalMessage = document.getElementById('modal-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // Default questions for the exam
            const defaultQuestions = [
                { question: "La Autoridad Fiscalizadora de la Seguridad Privada en Chile es la Prefectura de Carabineros de Chile del sector.", correctAnswer: "Verdadero" },
                { question: "La Ley N° 21.659, publicada en marzo de 2024, es la única ley que regula la seguridad privada en Chile actualmente.", correctAnswer: "Falso" },
                { question: "La seguridad privada, según las normativas vigentes antes de la Ley 21.659, busca reemplazar a la seguridad pública.", correctAnswer: "Falso" },
                { question: "Uno de los requisitos para ser Guardia de Seguridad según el Decreto 93 es tener 18 años.", correctAnswer: "Verdadero" },
                { question: "Los Guardias de Seguridad están autorizados para portar armas de fuego en el ejercicio de sus funciones según el Decreto 93.", correctAnswer: "Falso" },
                { question: "El curso de formación para Guardia de Seguridad, según el Decreto 93, tiene una duración de 90 horas.", correctAnswer: "Verdadero" },
                { question: "El seguro de vida para Guardias de Seguridad, según el Decreto 93, tiene una cifra asegurada de 75 UTM.", correctAnswer: "Verdadero" },
                { question: "El uniforme de un Guardia de Seguridad, según el Decreto 93, es libre y sin especificaciones de color.", correctAnswer: "Falso" },
                { question: "Un Guardia de Seguridad está facultado para detener a alguien solo en caso de sorprenderlo en delito flagrante.", correctAnswer: "Verdadero" },
                { question: "Delito es toda acción u omisión VOLUNTARIA penada por la Ley.", correctAnswer: "Verdadero" },
                { question: "Cuasidelito es toda acción u omisión INVOLUNTARIA, penada por la ley.", correctAnswer: "Verdadero" },
                { question: "La diferencia entre robo y hurto es que el robo se comete con violencia, intimidación o fuerza en las cosas, mientras que el hurto no.", correctAnswer: "Verdadero" },
                { question: "La legítima defensa es aplicable solo si existe presencia policial en el momento de la agresión.", correctAnswer: "Falso" },
                { question: "El sitio del suceso debe ser preservado y no alterado para la investigación.", correctAnswer: "Verdadero" },
                { question: "Una ronda fija se caracteriza por tener la hora y el trayecto preestablecidos.", correctAnswer: "Verdadero" },
                { question: "Los Guardias de Seguridad deben proteger personas y bienes, siendo la vida del guardia la más importante.", correctAnswer: "Verdadero" },
                { question: "Ante el hallazgo de un artefacto explosivo, la primera acción debe ser intentar desactivarlo si se tienen conocimientos.", correctAnswer: "Falso" },
                { question: "Una evacuación es el traslado ordenado de personas hacia una zona de seguridad designada.", correctAnswer: "Verdadero" },
                { question: "Una Directiva de Funcionamiento es un documento que señala el funcionamiento íntegro de los guardias de seguridad.", correctAnswer: "Verdadero" },
                { question: "El Estudio de Seguridad es aprobado por la Prefectura de Carabineros del sector.", correctAnswer: "Verdadero" },
                { question: "El porte ilegal de armas es portar un arma en la vía pública sin autorización.", correctAnswer: "Verdadero" },
                { question: "La Subsecretaría de Telecomunicaciones (SUBTEL) es la entidad que autoriza el uso de radiocomunicaciones en seguridad privada.", correctAnswer: "Verdadero" },
                { question: "En un supermercado, un guardia puede detener a una persona por consumir un alimento antes de pasar por caja, incluso si no ha salido del establecimiento.", correctAnswer: "Falso" },
                { question: "El secuestro es el traslado o retención de una o más personas sin su consentimiento.", correctAnswer: "Verdadero" },
                { question: "La misión de Carabineros de Chile incluye garantizar el Orden y la Seguridad Pública.", correctAnswer: "Verdadero" },
                { question: "Escalamiento es ingresar a una propiedad por una vía no destinada al efecto.", correctAnswer: "Verdadero" },
                { question: "La función principal de una antena en un transceptor portátil es amplificar el sonido.", correctAnswer: "Falso" },
                { question: "El contacto magnético es un sistema de alarma utilizado en puertas y ventanas para detectar aperturas.", correctAnswer: "Verdadero" },
                { question: "Los daños físicos y psíquicos sufridos por un guardia en el cumplimiento de sus funciones se consideran actos del servicio y pueden derivar en enfermedades profesionales.", correctAnswer: "Verdadero" },
                { question: "Para ser Guardia de Seguridad, se requiere haber cursado educación básica completa.", correctAnswer: "Falso" },
                { question: "No tiene responsabilidad penal quienes compran una cosa hurtada, ya que él no la sustrajo.", correctAnswer: "Falso" },
                { question: "La legítima defensa solamente se hace extensiva a la propia persona y no a terceros.", correctAnswer: "Falso" },
                { question: "Robo es la apropiación de una cosa sin que intervengan la fuerza o violencia.", correctAnswer: "Falso" },
                { question: "Son responsables en la comisión de un delito, los autores, los cómplices y los encubridores cuando en ellos solo se utilice imprudencia y negligencia.", correctAnswer: "Falso" },
                { question: "La policía debe eximir de responsabilidad penal al que obre en defensa de su persona o derechos, siempre que concurra, entre otras circunstancias la agresión legítima.", correctAnswer: "Verdadero" },
                { question: "La Nación políticamente organizada es sinónimo de Estado.", correctAnswer: "Verdadero" },
                { question: "En el sistema de vigilancia privada vigente, solo los Guardias de Seguridad, están sujetos a la fiscalización de la Autoridad Fiscalizadora de la prefectura de Carabineros de su sector jurisdiccional.", correctAnswer: "Falso" },
                { question: "En algunos casos los Guardias de Seguridad pueden actuar de civil, si están debidamente autorizados por la Autoridad Fiscalizadora.", correctAnswer: "Verdadero" },
                { question: "El O.S. 10 no puede fiscalizar a los Guardias de Seguridad los días domingos y festivos.", correctAnswer: "Falso" },
                { question: "No es obligación que los Guardias de Seguridad mantengan la Directiva de Funcionamiento en su respectiva instalación.", correctAnswer: "Falso" },
                { question: "Las alarmas son elementos manuales o eléctricos que se utilizan para advertir peligro o intrusión o de incendio.", correctAnswer: "Verdadero" },
                { question: "Para una adecuada detección de incendios deben existir mangueras adecuadas y grifos cercanos.", correctAnswer: "Falso" },
                { question: "Un sistema de alarmas debe tener etapas básicas, detección, control y respuesta.", correctAnswer: "Verdadero" },
                { question: "El circuito cerrado de Televisión es un complemento al sistema electrónico de alarma.", correctAnswer: "Verdadero" },
                { question: "La empresa de seguridad privada debe informar mensualmente a Carabineros sobre el personal que labora en sus instalaciones.", correctAnswer: "Verdadero" },
                { question: "Los guardias pueden realizar registros corporales a personas que ingresen a las instalaciones que custodian.", correctAnswer: "Falso" },
                { question: "El guardia de seguridad puede usar la fuerza física solo en legítima defensa propia o de terceros.", correctAnswer: "Verdadero" },
                { question: "Es obligatorio que el guardia de seguridad mantenga un libro de novedades actualizado durante su turno.", correctAnswer: "Verdadero" },
                { question: "El curso OS-10 debe ser renovado cada 3 años según la normativa vigente.", correctAnswer: "Falso" },
                { question: "Los guardias de seguridad pueden portar bastón de goma como elemento de protección personal.", correctAnswer: "Verdadero" },
                { question: "La detención por particulares no puede exceder de 24 horas sin entregar al detenido a la autoridad competente.", correctAnswer: "Verdadero" }
            ];

            let questions = [];
            let userAnswers = {};

            // Function to shuffle an array
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Function to generate quiz questions
            function generateQuestions() {
                console.log("generateQuestions function called.");
                
                // Show loading message
                quizContainer.innerHTML = '<p class="text-center text-info"><span class="spinner-border text-info" role="status"></span> Generando preguntas... Esto puede tardar unos segundos.</p>';
                quizContainer.style.display = 'block';
                startExamBtn.style.display = 'none';
                submitQuizBtn.style.display = 'none';

                // Activate persistent red border for the exam section
                examSection.classList.add('active-red-border');

                // Show subtle message box
                if (subtleResponseBox) { 
                    subtleResponseBox.style.display = 'block';
                    subtleResponseBox.classList.add('show');
                    subtleResponseBox.textContent = '¡Generando preguntas, por favor espera!';
                }

                // Simulate loading time and then generate questions
                setTimeout(() => {
                    // Usar exactamente las primeras 30 preguntas del banco (sin slice, ya que defaultQuestions tiene exactamente 50)
                    questions = shuffleArray(defaultQuestions).slice(0, 30); // Asegurar exactamente 30 preguntas
                    userAnswers = {};
                    
                    displayQuiz();
                    
                    if (subtleResponseBox) {
                        subtleResponseBox.textContent = '¡Exactamente 30 preguntas cargadas! Una vez que selecciones una respuesta, no podrás cambiarla. ¡Mucha suerte!';
                        setTimeout(() => {
                            subtleResponseBox.classList.remove('show');
                            setTimeout(() => subtleResponseBox.style.display = 'none', 500);
                        }, 4000); // Mostrar por 4 segundos para dar tiempo a leer el mensaje
                    }
                }, 1000);
            }

            // Function to display quiz questions
            function displayQuiz() {
                quizContainer.innerHTML = '';
                
                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.classList.add('question-card');
                    questionCard.innerHTML = `
                        <h5>${index + 1}. ${q.question}</h5>
                        <div class="options-container">
                            <label class="option-button" data-question="${index}" data-value="Verdadero">
                                <input class="form-check-input" type="radio" name="question${index}" value="Verdadero" style="display: none;">
                                Verdadero
                            </label>
                            <label class="option-button" data-question="${index}" data-value="Falso">
                                <input class="form-check-input" type="radio" name="question${index}" value="Falso" style="display: none;">
                                Falso
                            </label>
                        </div>
                        <div class="feedback-message mt-2" style="font-weight: 600; display: none;"></div>
                    `;
                    quizContainer.appendChild(questionCard);

                    // Add event listeners to option buttons
                    const optionButtons = questionCard.querySelectorAll('.option-button');
                    optionButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const questionIndex = parseInt(this.dataset.question);
                            
                            // Verificar si la pregunta ya fue respondida (NUEVA FUNCIONALIDAD)
                            if (userAnswers[questionIndex] !== undefined) {
                                // Si ya fue respondida, no hacer nada
                                return;
                            }
                            
                            const selectedValue = this.dataset.value;
                            const currentQuestion = questions[questionIndex];
                            const feedbackMessage = questionCard.querySelector('.feedback-message');

                            // Store user answer
                            userAnswers[questionIndex] = selectedValue;

                            // Remove all selected/feedback classes from this question
                            optionButtons.forEach(btn => {
                                btn.classList.remove('selected', 'correct', 'incorrect');
                            });

                            // Add selected class to clicked button
                            this.classList.add('selected');
                            
                            // Show immediate feedback
                            if (selectedValue === currentQuestion.correctAnswer) {
                                this.classList.add('correct');
                                feedbackMessage.style.color = '#28a745';
                                feedbackMessage.textContent = '¡Correcto!';
                            } else {
                                this.classList.add('incorrect');
                                feedbackMessage.style.color = '#dc3545';
                                feedbackMessage.textContent = `Incorrecto. La respuesta correcta era: "${currentQuestion.correctAnswer}".`;
                            }

                            feedbackMessage.style.display = 'block';
                            questionCard.classList.add('answered-blue-border');
                            
                            // BLOQUEAR TODOS LOS BOTONES DE ESTA PREGUNTA (NUEVA FUNCIONALIDAD)
                            optionButtons.forEach(btn => {
                                btn.style.pointerEvents = 'none';
                                btn.style.opacity = '0.8';
                                btn.style.cursor = 'not-allowed';
                            });
                            
                            // Agregar texto explicativo de que la respuesta está bloqueada
                            const lockMessage = document.createElement('div');
                            lockMessage.style.cssText = 'font-size: 0.8em; color: #666; margin-top: 8px; font-style: italic;';
                            lockMessage.textContent = '🔒 Respuesta registrada - No se puede modificar';
                            feedbackMessage.appendChild(lockMessage);

                            // Check if all questions are answered
                            if (Object.keys(userAnswers).length === questions.length) {
                                submitQuizBtn.style.display = 'block';
                                // Mostrar mensaje de que puede enviar el examen
                                showSubtleMessage('¡Todas las preguntas respondidas! Puedes enviar tu examen.');
                            }
                        });
                    });
                });

                console.log("Quiz questions displayed.");
            }

            // Function to submit quiz and calculate score
            function submitQuiz() {
                let score = 0;
                questions.forEach((q, index) => {
                    if (userAnswers[index] === q.correctAnswer) {
                        score++;
                    }
                });

                const maxScore = questions.length;
                const percentage = (score / maxScore) * 100;
                const grade = calculateGrade(percentage);
                const passed = grade >= 4.0;

                // Populate modal content
                modalCorrectCount.textContent = score;
                modalTotalQuestions.textContent = maxScore;
                modalPercentage.textContent = percentage.toFixed(1);
                modalGrade.textContent = grade.toFixed(1);

                // Set modal message and color
                resultsModalContent.classList.remove('pass', 'fail');
                if (passed) {
                    modalMessage.textContent = '¡Felicitaciones! Has aprobado.';
                    resultsModalContent.classList.add('pass');
                } else {
                    modalMessage.textContent = 'Necesitas repasar más. ¡No te desanimes!';
                    resultsModalContent.classList.add('fail');
                }

                // Show the modal
                resultsModalOverlay.style.display = 'flex';
                setTimeout(() => resultsModalOverlay.classList.add('show'), 10);

                submitQuizBtn.style.display = 'none';
                
                // Disable all option buttons
                document.querySelectorAll('.option-button').forEach(button => {
                    button.style.pointerEvents = 'none';
                    button.style.opacity = '0.7';
                });

                console.log("Quiz submitted and results displayed in modal. Score:", score);
            }

            // Function to calculate grade from 1 to 7
            function calculateGrade(percentage) {
                if (percentage < 30) return 1.0;
                if (percentage < 40) return 2.0;
                if (percentage < 50) return 3.0;
                if (percentage < 60) return 4.0;
                if (percentage < 70) return 5.0;
                if (percentage < 85) return 6.0;
                return 7.0;
            }

            // Event listeners
            startExamBtn.addEventListener('click', generateQuestions);
            submitQuizBtn.addEventListener('click', submitQuiz);

            // Close modal button listener
            closeModalBtn.addEventListener('click', () => {
                resultsModalOverlay.classList.remove('show');
                setTimeout(() => {
                    resultsModalOverlay.style.display = 'none';
                    resultsModalContent.classList.remove('pass', 'fail');
                    
                    // Reset exam
                    quizContainer.style.display = 'none';
                    startExamBtn.style.display = 'block';
                    submitQuizBtn.style.display = 'none';
                    examSection.classList.remove('active-red-border');
                    questions = [];
                    userAnswers = {};
                }, 300);
            });

            // Click outside modal to close
            resultsModalOverlay.addEventListener('click', (e) => {
                if (e.target === resultsModalOverlay) {
                    closeModalBtn.click();
                }
            });

            // --- Report Drafting Assistant Logic ---
            const incidentDescriptionInput = document.getElementById('incident-description-input');
            const reportTypeSelect = document.getElementById('report-type-select');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const reportOutput = document.getElementById('report-output');
            const copyReportBtn = document.getElementById('copy-report-btn');
            const downloadActaBtn = document.getElementById('download-acta-btn');

            // Hide report action buttons on init
            copyReportBtn.style.display = 'none';
            downloadActaBtn.style.display = 'none';

            generateReportBtn.addEventListener('click', async () => {
                const description = incidentDescriptionInput.value.trim();
                const selectedReportType = reportTypeSelect.value;

                if (!description) {
                    reportOutput.innerHTML = '<p style="color: #dc3545;">Por favor, describe el incidente.</p>';
                    copyReportBtn.style.display = 'none';
                    downloadActaBtn.style.display = 'none';
                    return;
                }

                reportOutput.innerHTML = '<p style="color: #17a2b8;"><span class="spinner-border text-info" role="status"></span> Generando borrador...</p>';
                generateReportBtn.disabled = true;
                copyReportBtn.style.display = 'none';
                downloadActaBtn.style.display = 'none';

                if (selectedReportType === 'acta_detencion_particulares') {
                    // For Detention Act, show download button directly
                    reportOutput.innerHTML = `<p style="color: #28a745;">Haz clic en el botón para descargar el Acta de Detención:</p>`;
                    downloadActaBtn.style.display = 'block';
                    generateReportBtn.disabled = false;
                    console.log("Showing Detention Act download button.");
                    return;
                }

                // Generate a simulated report based on the type and description
                setTimeout(() => {
                    let generatedReport = '';
                    const currentDate = new Date().toLocaleDateString('es-CL');
                    const currentTime = new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });

                    switch (selectedReportType) {
                        case 'informe_interno':
                            generatedReport = `INFORME INTERNO DE INCIDENTE

Fecha: ${currentDate}
Hora: ${currentTime}
Ubicación del Incidente: ${extractLocation(description) || 'No especificado'}
Tipo de Incidente: ${classifyIncident(description)}

DESCRIPCIÓN DETALLADA DEL EVENTO:
${description}

PERSONAL DE SEGURIDAD INVOLUCRADO:
Guardia de Seguridad: [Nombre del guardia]
Cargo: Guardia de Seguridad
Acciones Iniciales: Observación del incidente y aplicación de protocolo establecido

ACCIONES TOMADAS:
- Se procedió según protocolo de seguridad establecido
- ${containsKeywords(description, ['carabineros', 'policía', 'autoridad']) ? 'Se notificó a Carabineros de Chile' : 'Se evaluó la necesidad de contactar autoridades'}
- Se documentó el incidente para registro interno

EVIDENCIA RECOLECTADA:
- Testimonio del guardia de seguridad
- ${containsKeywords(description, ['cámara', 'video', 'grabación']) ? 'Revisión de cámaras de seguridad' : 'No especificado'}

RECOMENDACIONES/OBSERVACIONES:
Se recomienda mantener los protocolos de seguridad vigentes y evaluar medidas preventivas adicionales si corresponde.

Firma del Guardia: ___________________
Fecha de elaboración: ${currentDate}`;
                            break;

                        case 'comunicacion_policial':
                            generatedReport = `COMUNICACIÓN A CARABINEROS DE CHILE

Fecha: ${currentDate}
Hora del Incidente: ${currentTime}
Lugar del Incidente: ${extractLocation(description) || 'No especificado'}
Tipo de Incidente: ${classifyIncident(description)}

DESCRIPCIÓN DEL EVENTO:
En la fecha y hora señalada, se registró el siguiente incidente: ${description}

ACCIONES INMEDIATAS TOMADAS:
- Observación y documentación del evento
- Aplicación de protocolo de seguridad establecido
- ${containsKeywords(description, ['detenido', 'retención', 'sospechoso']) ? 'Se procedió según normativa de detención por particulares' : 'Se mantuvo observación del área'}

Se pone en conocimiento de la autoridad policial para los fines que estime conveniente.

Atentamente,
[Nombre del Guardia de Seguridad]
[Empresa de Seguridad]`;
                            break;

                        case 'correo_supervisor':
                            generatedReport = `Asunto: Reporte de Incidente - ${currentDate}

Estimado Supervisor,

Por medio del presente, informo sobre el siguiente incidente ocurrido en mi turno:

Fecha y Hora: ${currentDate} - ${currentTime}
Resumen del Evento: ${description}

ACCIONES TOMADAS:
- Se aplicó el protocolo de seguridad correspondiente
- Se documentó el incidente según procedimiento
- ${containsKeywords(description, ['urgente', 'grave', 'inmediato']) ? 'Se considera necesaria supervisión adicional' : 'Situación bajo control'}

${containsKeywords(description, ['decisión', 'autorización', 'supervisor']) ? 'REQUIERE ACCIÓN DEL SUPERVISOR:\nSe solicita orientación para próximos pasos a seguir.' : 'SITUACIÓN CONTROLADA:\nNo se requiere acción inmediata adicional.'}

Quedo a disposición para cualquier aclaración adicional.

Saludos cordiales,
[Nombre del Guardia]`;
                            break;

                        case 'reporte_general':
                            generatedReport = `REPORTE GENERAL DE EVENTO

Fecha: ${currentDate}
Hora: ${currentTime}
Ubicación: ${extractLocation(description) || 'No especificado'}
Naturaleza del Evento: ${classifyIncident(description)}

DESCRIPCIÓN:
${description}

PERSONAS AFECTADAS/INVOLUCRADAS:
${containsKeywords(description, ['persona', 'cliente', 'empleado', 'visitante']) ? 'Personal y/o visitantes presentes en el área' : 'No especificado'}

MEDIDAS ADOPTADAS:
- Observación y registro del evento
- Aplicación de protocolos de seguridad vigentes
- Documentación para registro institucional

ESTADO ACTUAL:
Situación normalizada y bajo control.

Elaborado por: [Nombre del Guardia]
Fecha de elaboración: ${currentDate}`;
                            break;

                        default:
                            generatedReport = 'Error: Tipo de reporte no reconocido.';
                    }

                    reportOutput.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding: 10px; border-radius: 5px; color: #333; margin: 0;">${generatedReport}</pre>`;
                    copyReportBtn.style.display = 'block';
                    generateReportBtn.disabled = false;
                }, 1500);
            });

            copyReportBtn.addEventListener('click', () => {
                const reportContent = reportOutput.textContent;
                navigator.clipboard.writeText(reportContent).then(() => {
                    showSubtleMessage('¡Borrador copiado al portapapeles!');
                }).catch(err => {
                    console.error('Error al copiar el borrador:', err);
                    showSubtleMessage('No se pudo copiar el borrador.', true);
                });
            });

            // Helper functions for report generation
            function extractLocation(text) {
                const locationKeywords = ['tienda', 'oficina', 'entrada', 'estacionamiento', 'recepción', 'pasillo', 'sector', 'área'];
                for (let keyword of locationKeywords) {
                    if (text.toLowerCase().includes(keyword)) {
                        return keyword.charAt(0).toUpperCase() + keyword.slice(1);
                    }
                }
                return null;
            }

            function classifyIncident(text) {
                const lowerText = text.toLowerCase();
                if (lowerText.includes('hurto') || lowerText.includes('robo')) return 'Hurto/Robo';
                if (lowerText.includes('accidente')) return 'Accidente';
                if (lowerText.includes('sospechoso') || lowerText.includes('extraño')) return 'Actividad Sospechosa';
                if (lowerText.includes('emergencia')) return 'Emergencia';
                if (lowerText.includes('incendio') || lowerText.includes('fuego')) return 'Incendio';
                if (lowerText.includes('altercado') || lowerText.includes('pelea')) return 'Altercado';
                return 'Incidente General';
            }

            function containsKeywords(text, keywords) {
                const lowerText = text.toLowerCase();
                return keywords.some(keyword => lowerText.includes(keyword.toLowerCase()));
            }

            // Function to show subtle messages
            function showSubtleMessage(message, isError = false) {
                const messageBox = document.createElement('div');
                messageBox.className = 'subtle-response-box show';
                messageBox.textContent = message;
                messageBox.style.position = 'fixed';
                messageBox.style.top = '20%';
                messageBox.style.left = '50%';
                messageBox.style.transform = 'translate(-50%, -50%)';
                messageBox.style.zIndex = '1500';

                if (isError) {
                    messageBox.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
                    messageBox.style.color = '#dc3545';
                } else {
                    messageBox.style.backgroundColor = 'rgba(40, 53, 147, 0.2)';
                    messageBox.style.color = '#283593';
                }

                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.classList.remove('show');
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }

            // --- AI Clarifier Logic (Floating) ---
            const floatingAiButton = document.getElementById('floating-ai-button');
            const aiClarifierChat = document.getElementById('ai-clarifier-chat');
            const closeAiChatBtn = document.getElementById('close-ai-chat');
            const aiQuestionInput = document.getElementById('ai-question-input');
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiClarifierResponse = document.getElementById('ai-clarifier-response');

            floatingAiButton.addEventListener('click', () => {
                console.log("Floating AI button clicked. Toggling chat visibility.");
                aiClarifierChat.classList.toggle('show');
            });

            closeAiChatBtn.addEventListener('click', () => {
                console.log("Close chat button clicked. Hiding chat.");
                aiClarifierChat.classList.remove('show');
                aiQuestionInput.value = '';
                aiClarifierResponse.innerHTML = '<p>Tu respuesta aparecerá aquí.</p>';
            });

            askAiBtn.addEventListener('click', async function() {
                const userQuestion = aiQuestionInput.value.trim();
                if (userQuestion === "") {
                    aiClarifierResponse.innerHTML = '<p style="color: #dc3545;">Por favor, escribe tu pregunta.</p>';
                    return;
                }

                aiClarifierResponse.innerHTML = '<p style="color: #17a2b8;"><span class="spinner-border text-info" role="status"></span> Cargando respuesta de la IA... Esto puede tardar unos segundos.</p>';
                askAiBtn.disabled = true;
                console.log("Ask AI button clicked. Generating response for:", userQuestion);

                // Simulate AI response generation
                setTimeout(() => {
                    const response = generateAIResponse(userQuestion);
                    aiClarifierResponse.innerHTML = `<p>${response}</p>`;
                    askAiBtn.disabled = false;
                    console.log("AI Clarifier response generated and displayed.");
                }, 2000);
            });

            // Function to generate simulated AI responses
            function generateAIResponse(question) {
                const lowerQuestion = question.toLowerCase();
                
                // Respuestas sobre Decreto 93
                if (lowerQuestion.includes('decreto 93') && (lowerQuestion.includes('requisito') || lowerQuestion.includes('educación'))) {
                    return "Según el Decreto 93, para ser Guardia de Seguridad se requiere: tener al menos 18 años de edad, haber cursado educación media completa o su equivalente, no tener antecedentes penales, aprobar examen psicológico y físico, y completar el curso de formación de 90 horas académicas.";
                }
                
                if (lowerQuestion.includes('decreto 93') && (lowerQuestion.includes('uniforme') || lowerQuestion.includes('vestimenta'))) {
                    return "El Decreto 93 establece que el uniforme del guardia debe ser de color azul marino, con distintivos que identifiquen a la empresa y al guardia. Debe incluir placa identificatoria con nombre y RUN, y no puede asemejarse a uniformes de Fuerzas Armadas o de Orden.";
                }
                
                if (lowerQuestion.includes('decreto 93') && (lowerQuestion.includes('seguro') || lowerQuestion.includes('utM'))) {
                    return "El Decreto 93 establece que las empresas deben contratar un seguro de vida para sus guardias con una cifra asegurada de 75 UTM, que cubra accidentes y enfermedades derivadas del trabajo.";
                }
                
                // Respuestas sobre funciones del guardia
                if (lowerQuestion.includes('función') || lowerQuestion.includes('responsabilidad')) {
                    return "Las principales funciones del guardia de seguridad incluyen: vigilar y proteger bienes y personas, detectar y prevenir actos que atenten contra la seguridad, informar novedades a superiores, aplicar medidas de seguridad según protocolos, y colaborar con autoridades cuando sea requerido.";
                }
                
                if (lowerQuestion.includes('detención') || lowerQuestion.includes('detener')) {
                    return "Los guardias pueden detener a personas solo en caso de delito flagrante, aplicando el Artículo 134 del Código Procesal Penal. Deben entregar inmediatamente al detenido a Carabineros y no pueden usar fuerza excesiva.";
                }
                
                // Respuestas sobre Ley 21.659
                if (lowerQuestion.includes('ley 21.659') || lowerQuestion.includes('nueva ley')) {
                    return "La Ley 21.659 moderniza la regulación de seguridad privada en Chile. Entra en vigencia el 28 de noviembre de 2025 y establece nuevos estándares para empresas y guardias, fortalece la fiscalización y mejora los requisitos de formación.";
                }
                
                // Respuestas sobre armamento
                if (lowerQuestion.includes('arma') || lowerQuestion.includes('armamento')) {
                    return "Los guardias de seguridad NO están autorizados para portar armas de fuego según el Decreto 93. Solo pueden usar elementos de protección personal autorizados como bastón de goma, silbato y linterna.";
                }
                
                // Respuestas sobre procedimientos
                if (lowerQuestion.includes('procedimiento') || lowerQuestion.includes('protocolo')) {
                    return "Los guardias deben seguir protocolos establecidos: observar y reportar, no alterar sitio del suceso, preservar evidencias, comunicar novedades de inmediato, actuar con prudencia y solicitar apoyo cuando sea necesario.";
                }
                
                // Respuestas sobre formación
                if (lowerQuestion.includes('curso') || lowerQuestion.includes('formación') || lowerQuestion.includes('90 horas')) {
                    return "El curso OS-10 para guardias de seguridad tiene una duración de 90 horas académicas y debe incluir materias como: legislación, procedimientos de seguridad, primeros auxilios, comunicaciones, derechos humanos y ética profesional.";
                }
                
                // Respuesta general
                return "Basándome en la normativa chilena de seguridad privada (Decreto Ley 3607, Decreto 93 y Ley 21.659), puedo ayudarte con temas específicos sobre funciones del guardia, requisitos, procedimientos y marco legal. ¿Podrías ser más específico con tu consulta?";
            }

            console.log("Quiz system and AI Clarifier initialized successfully.");
        });
    </script>

</body>
</html>
